<?php// Input: location string with long and lat in format: (44.44243,54.234325)// Output: Array, each entry containing JSON information for one listing  function getListings($location){ //function parameters, two variables.  		//Remove parenthesis from string	$locationClean = str_replace('(', '', $location);	$locationClean = str_replace(')', '', $locationClean);	$locationClean = str_replace(' ', '', $locationClean);		// echo (int)$_POST['slider_location'];	  	 // Build the url string for http communication	 $offset = 0;	 $limit = 500;	 $totalCount = 1000;	 $listingsArray = array();	 	 //Iterate and perform multiple http-requests since Booli-API only permits 500 listings per call	 while ($offset < $totalCount) {		 $auth = array();	  $auth['callerId'] = "PriceVisualization";	  $auth['time'] = time();	  $auth['unique'] = rand(0, PHP_INT_MAX);	  $auth['hash'] = sha1($auth['callerId'] . $auth['time'] . "0LJN0MwJ8issGAkXVgsQOdscWhRjARy2eyzyqkKO" . $auth['unique']);	$url = "http://api.booli.se/listings/?center=".$locationClean."&dim=200000,200000&"."offset=".$offset."&limit=".$limit."&" . http_build_query($auth);	 /* 	  $message = "yoo";	 echo "<script type='text/javascript'>alert('$message');</script>";	 */			  // Use curl to communicate with Booli API	  $curl = curl_init($url);	  	  curl_setopt_array($curl, array(		  CURLOPT_RETURNTRANSFER => true	  ));	 	  	  // $response is a JSON string	  $response = curl_exec($curl); 	  	  $httpCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);	  	  curl_close($curl);	  	  /*if ($httpCode != 200) {		  echo "Fail!";	  }else{		  echo "Success!";	  }*/	   	  // $result is a JSON object  	  $result = json_decode($response);	  $totalCount = $result->totalCount; //Get the total number of listings	  $offset = $offset + $limit; //Increase offset	  	  //Append the listings	  $listings = $result->listings;	  $listingsArray = array_merge($listingsArray,$listings);	  //$aListing = $listings[0];	  //echo $aListing->booliId;	  	 }	 foreach($listingsArray as $listing){		 		 $arr = explode(",", $locationClean, 2);		 $latitudeFrom = $arr[0];		 $longitudeFrom = $arr[1];		 $latitudeTo = $listing->location->position->latitude;		 $longitudeTo = $listing->location->position->longitude;		 $distance = haversineGreatCircleDistance($latitudeFrom, $longitudeFrom, $latitudeTo, $longitudeTo, $earthRadius = 6371000);		 $distance = round($distance, 0);		 $listing->distance = $distance;	 }	$testList = $listingsArray[0];	$testDist = $testList->distance;	 /*echo "<script type='text/javascript'>alert('$totalCount');</script>";*/    return $listingsArray;  //returns the second argument passed into the function  }    // Scripts the location in the map so it can focus on the point of interest after optimization. I.e. a way of relaying the position to JS  function setLocationToMap($location){	  	  //Extract the longitude and latitude from string	  $longitude =  substr($location, 1, strpos($location, ',')-1);	$latitude =  substr($location, strpos($location, ',')+2, strpos($location, ')')-strpos($location, ',')-2);		//Set the variables in html script so they can be accessed by JS	echo "<script>		var initLat = ". $longitude.";		var initLong = ".$latitude.";		var zoomLevel = 8;	</script>";  }      /** * Calculates the great-circle distance between two points, with * the Haversine formula. * @param float $latitudeFrom Latitude of start point in [deg decimal] * @param float $longitudeFrom Longitude of start point in [deg decimal] * @param float $latitudeTo Latitude of target point in [deg decimal] * @param float $longitudeTo Longitude of target point in [deg decimal] * @param float $earthRadius Mean earth radius in [m] * @return float Distance between points in [m] (same as earthRadius) */function haversineGreatCircleDistance(  $latitudeFrom, $longitudeFrom, $latitudeTo, $longitudeTo, $earthRadius = 6371000){  // convert from degrees to radians  $latFrom = deg2rad($latitudeFrom);  $lonFrom = deg2rad($longitudeFrom);  $latTo = deg2rad($latitudeTo);  $lonTo = deg2rad($longitudeTo);  $latDelta = $latTo - $latFrom;  $lonDelta = $lonTo - $lonFrom;  $angle = 2 * asin(sqrt(pow(sin($latDelta / 2), 2) +    cos($latFrom) * cos($latTo) * pow(sin($lonDelta / 2), 2)));  return $angle * $earthRadius;}    ?>